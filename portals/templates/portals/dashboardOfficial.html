{% extends 'portals/base.html' %}

{% load static %}

{% block content %}
{% include 'portals/sidebarOfficial.html' %}

<main class="page-content">
<div class="container-fluid">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-transparent  bg-primary  navbar-absolute">
   
        <div class="container-fluid">
          <div class="navbar-wrapper">
            
          </div>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-bar navbar-kebab"></span>
            <span class="navbar-toggler-bar navbar-kebab"></span>
            <span class="navbar-toggler-bar navbar-kebab"></span>
          </button>
          <div class="collapse navbar-collapse justify-content-end" id="navigation">
            
            <ul class="navbar-nav">
              <li class="nav-item">
                <a class="nav-link" href="#pablo">
                  <i class="now-ui-icons media-2_sound-wave"></i>
                  <p>
                    <span class="d-lg-none d-md-block">Stats</span>
                  </p>
                </a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="now-ui-icons location_world"></i>
                  <p>
                    <span class="d-lg-none d-md-block">Some Actions</span>
                  </p>
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                  <a class="dropdown-item" href="#">Account Management</a>
                  <a class="dropdown-item" href="#">Profile picture</a>
                  <a class="dropdown-item" href="#">Change Password</a>
                  <a class="dropdown-item" href="{% url 'logout' %}">Logout</a>
                </div>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#pablo">
                  <i class="now-ui-icons users_single-02"></i>
                  <p>
                    <span class="d-lg-none d-md-block">Account</span>
                  </p>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      <!-- End Navbar -->
      <div class="panel-header panel-header-lg">
      </div>
      <div class="content">
        <div class="row">
          <div class="col-md-12">
            <div class="card">
              <div class="card-header">
                                <h4 class="">Government Official Dashboard</h4>
                                  <!-- Content Wrapper. Contains page content -->
      <div class="card-body">
        <div class="row">

          <div class="col-lg-3 col-6">
            <!-- small box -->
            <div class="small-box bg-info">
              <div class="inner">
                <h3>150</h3>

                <p>New Orders</p>
              </div>
              <div class="icon">
                <i class="ion ion-bag"></i>
              </div>
              <a href="#" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
            </div>
          </div>
          <!-- ./col -->
          <div class="col-lg-3 col-6">
            <!-- small box -->
            <div class="small-box bg-success">
              <div class="inner">
                <h3>53<sup style="font-size: 20px">%</sup></h3>

                <p>Bounce Rate</p>
              </div>
              <div class="icon">
                <i class="ion ion-stats-bars"></i>
              </div>
              <a href="#" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
            </div>
          </div>
          <!-- ./col -->
          <div class="col-lg-3 col-6">
            <!-- small box -->
            <div class="small-box bg-warning">
              <div class="inner">
                <h3>44</h3>

                <p>User Registrations</p>
              </div>
              <div class="icon">
                <i class="ion ion-person-add"></i>
              </div>
              <a href="#" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
            </div>
          </div>
          <!-- ./col -->
          <div class="col-lg-3 col-6">
            <!-- small box -->
            <div class="small-box bg-danger">
              <div class="inner">
                <h3>65</h3>

                <p>Unique Visitors</p>
              </div>
              <div class="icon">
                <i class="ion ion-pie-graph"></i>
              </div>
              <a href="#" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
            </div>
          </div>
          


        <div class="card mb-4">
          <div class="card-header border-0">
            <h3 class="card-title">Statistics</h3>
            <div class="card-tools">
              <a href="#" class="btn btn-tool btn-sm"> <i class="bi bi-download"></i> </a>
              <a href="#" class="btn btn-tool btn-sm"> <i class="bi bi-list"></i> </a>
            </div>
          </div>
          <div class="card-body table-responsive p-0">
            <table class="table table-striped align-middle">
              <thead>
                  <tr>
                    <th>Records</th>                      
                      <th>Practitioner</th> <!-- New Column -->
                      <th>Category</th>
                      <th>Query</th>
                      <th>From</th>
                      <th>To</th>
                      <th>Total</th>
                  </tr>
              </thead>
              <tbody id="recordsTable">
                <tr>
                  <td>Artificial Insemination</td>
                    <td>
                        <select class="form-control" id="user_dropdown_ai" style="width: 150px;">
                            <option value="All">All</option>
                            {% for vet in all_vets %}
                            <option value="{{ vet.username }}">{{ vet.username }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    
                    <td>
                        <select class="form-control" id="animal_species_ai" style="width: 150px;">
                          <option value="All">All</option>
                            {% for value, display in ANIMAL_SPECIES %}
                            <option value="{{ value }}">{{ display }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td><p></p></td>
                    <td>
                        <input type="date" id="ai_date_from" value="2020-01-01" class="form-control" style="width: 150px;">
                    </td>
                    <td>
                        <input type="date" id="ai_date_to" value="2025-01-01" class="form-control" style="width: 150px;">
                    </td>
                    <td>
                        <h2 id="ai_total">0</h2>
                    </td>
                </tr>
            
                <tr>
                  <td>Vaccination</td>
                    <td>
                        <select class="form-control" id="user_dropdown_vaccination" style="width: 150px;">
                          <option value="All">All</option>
                            {% for vet in all_vets %}
                            <option value="{{ vet.username }}">{{ vet.username }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    
                    <td>
                        <select id="species_vaccination" class="form-control" style="width: 150px;">
                          <option value="All">All</option>
                            {% for value, display in ANIMAL_SPECIES_CHOICES %}
                            <option value="{{ value }}">{{ display }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <select id="vaccination_of_vaccination" class="form-control" style="width: 150px;">
                          <option value="All">All</option>
                            {% for value, display in DISEASE_CHOICES %}
                            <option value="{{ value }}">{{ display }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <input type="date" id="vaccination_date_from" value="2020-01-01" class="form-control" style="width: 150px;">
                    </td>
                    <td>
                        <input type="date" id="vaccination_date_to" value="2025-01-01" class="form-control" style="width: 150px;">
                    </td>
                    <td>
                        <h2 id="vaccination_total">0</h2>
                    </td>
                </tr>
            
                <tr>
                  <td>Meat Inspection</td>
                    <td>
                        <select class="form-control" id="user_filter" style="width: 150px;">
                          <option value="All">All</option>
                            {% for vet in all_vets %}
                            <option value="{{ vet.username }}">{{ vet.username }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    
                    <td>
                        <select class="form-control" id="livestock_category" style="width: 150px;">
                          <option value="All">All</option>
                            {% for value, display in MEAT_CATEGORY_CHOICES %}
                            <option value="{{ value }}">{{ display }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td><p></p></td>
                    <td>
                        <input type="date" id="meat_date_from" value="2020-01-01" class="form-control" style="width: 150px;">
                    </td>
                    <td>
                        <input type="date" id="meat_date_to" value="2026-01-01" class="form-control" style="width: 150px;">
                    </td>
                    <td>
                        <h2 id="meat_total">0</h2>
                    </td>
                </tr>

                <tr>
                  <td>Registered Practitioners</td>
                    <td>
                      <select class="form-control" id="official_filter" style="width: 150px;" disabled>
                        <option value="All">All</option>
                        
                    </select>  
                    </td>
                    
                    <td>
                        <select id="vetcategory" class="form-control" style="width: 150px;">
                          <option value="All">All</option>
                            {% for value, display in VET_CAT_CH %}
                            <option value="{{ value }}">{{ display }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <select id="subcounty" class="form-control" style="width: 150px;">
                          <option value="All">All</option>
                            {% for value, display in SUB_COUNTY %}
                            <option value="{{ value }}">{{ display }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <input type="date" id="vet_date_from" value="2020-01-01" class="form-control" style="width: 150px;">
                    </td>
                    <td>
                        <input type="date" id="vet_date_to" value="2025-01-01" class="form-control" style="width: 150px;">
                    </td>
                    <td>
                        <h2 id="vet_total">0</h2>
                    </td>
                </tr>
            </tbody>
            
          </table>
          
          </div>
        </div>
          <!-- right col -->
        </div>
        <!-- /.row (main row) -->
      </div><!-- /.container-fluid -->
      </div>
      </div>
      </div>
      </div>
      </div>
      </main>

    
      <footer class="footer">
        <div class=" container-fluid ">
            <div class="copyright">
              &copy; Copyright <strong><span>SoinVet</span></strong>. All Rights Reserved
              <div class="credits">
               
            </div>
          </div>
        </footer><!-- End Footer -->
  <!--   Core JS Files   -->
  <script src="{% static 'portals/assets/js/vanilla-calendar.min.js' %}"></script>
  <script src="{% static 'portals/assets/js/core/jquery.min.js' %}"></script>
  <script src="{% static 'portals/assets/js/core/popper.min.js' %}"></script>
  <script src="{% static 'portals/assets/js/core/bootstrap.min.js' %}"></script>
 
 
  <!-- Control Center for Now Ui Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="{% static 'portals/assets/js/now-ui-dashboard.min.js' %}" type="text/javascript"></script><!-- Now Ui Dashboard DEMO methods, don't include it in your project! -->
  <script src="{% static 'portals/assets/js/main.js' %}"></script>
  
      <script src="{% static 'portals/assets/dist/js/adminlte.js' %}"></script>
      <script src="{% static 'portals/assets//js/calendar.js' %}"></script>
      <!-- AdminLTE dashboard demo (This is only for demo purposes) -->
      <script src="{% static 'portals/assets/dist/js/pages/dashboard.js' %}"></script>
      <!-- AdminLTE for demo purposes -->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.5.1/snap.svg.js" integrity="sha512-2B4yJ2DGhmYITzY51PcSK5pxQilqi1Cl3wgI8dq8phWjbVAw9SmcaTZp+QsSCdV/xKkxttyYolU0usNNG1ICbQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  
      <script src="{% static 'portals/assets/dist/js/demo.js' %}"></script>
      <script src="{% static 'portals/assets/js/clock.js' %}"></script>
      <script>
        document.addEventListener("DOMContentLoaded", () => {
          const filters = [
              {
                  userDropdown: "user_dropdown_ai",
                  speciesDropdown: "animal_species_ai",
                  dateFromInput: "ai_date_from",
                  dateToInput: "ai_date_to",
                  totalElement: "ai_total",
                  apiUrl: "/ai_filter/",
                  dateField: "insemination_date",
                  speciesField: "species",
                  userField: "assigned_by_username"
              },
              {
                  userDropdown: "user_dropdown_vaccination",
                  speciesDropdown: "species_vaccination",
                  vaccinationDropdown: "vaccination_of_vaccination",
                  dateFromInput: "vaccination_date_from",
                  dateToInput: "vaccination_date_to",
                  totalElement: "vaccination_total",
                  apiUrl: "/vaccination_filter/",
                  dateField: "date_of_vaccination",
                  speciesField: "species_targeted",
                  vaccinationField: "vaccination_of",
                  userField: "assigned_by_username",
                  sumField: "number_of_animals_vaccinated"
              },
              {
                  userDropdown: "user_filter",
                  speciesDropdown: "livestock_category",
                  dateFromInput: "meat_date_from",
                  dateToInput: "meat_date_to",
                  totalElement: "meat_total",
                  apiUrl: "/kills_filter/",
                  dateField: "inspection_date",
                  speciesField: "livestock_category",
                  userField: "assigned_by_username",
                  sumField: "total_kills_per_day"
              },
              {
                  userDropdown: "official_filter",
                  countyDropdown: "subcounty",
                  categoryDropdown: "vetcategory",
                  dateFromInput: "vet_date_from",
                  dateToInput: "vet_date_to",
                  totalElement: "vet_total",
                  apiUrl: "/prac-filter/",
                  dateField: "reg_date",
                  countyField: "subcounty",
                  categoryField: "vet_category",
                  userField: "assigned_by_username"
              }
          ];
      
          filters.forEach(filter => {
              const userDropdown = document.getElementById(filter.userDropdown);
              const speciesDropdown = document.getElementById(filter.speciesDropdown);
              const countyDropdown = filter.countyDropdown ? document.getElementById(filter.countyDropdown) : null;
              const categoryDropdown = filter.categoryDropdown ? document.getElementById(filter.categoryDropdown) : null;
              const vaccinationDropdown = filter.vaccinationDropdown ? document.getElementById(filter.vaccinationDropdown) : null;
              const dateFromInput = document.getElementById(filter.dateFromInput);
              const dateToInput = document.getElementById(filter.dateToInput);
              const totalElement = document.getElementById(filter.totalElement);
      
              const today = new Date();
              if (dateToInput) {
                  dateToInput.value = today.toISOString().split('T')[0];
              }
      
              let fetchedData = [];
      
              async function fetchData() {
                  try {
                      const response = await fetch(filter.apiUrl);
                      const data = await response.json();
                      console.log(data);
      
                      fetchedData.splice(0, fetchedData.length, ...(data.records || []));
                      filterData();
                  } catch (error) {
                      console.error("Error fetching data:", error);
                  }
              }
      
              function filterData() {
                  const selectedUser = userDropdown ? userDropdown.value : null;
                  const selectedSpecies = speciesDropdown ? speciesDropdown.value : null;
                  const selectedCounty = countyDropdown ? countyDropdown.value : null;
                  const selectedCategory = categoryDropdown ? categoryDropdown.value : null;
                  const selectedVaccination = vaccinationDropdown ? vaccinationDropdown.value : null;
                  const dateFrom = dateFromInput?.value ? new Date(dateFromInput.value) : null;
                  const dateTo = dateToInput?.value ? new Date(dateToInput.value) : null;
      
                  let dataToFilter = fetchedData;
      
                  // ✅ Filter by selected user if not "All"
                  if (filter.userField && selectedUser && selectedUser !== "All") {
                      dataToFilter = dataToFilter.filter(record =>
                          record[filter.userField] === selectedUser
                      );
                  }
      
                  // ✅ Apply additional filters
                  const filteredData = dataToFilter.filter(record => {
                      const recordDate = new Date(
                          record[filter.dateField] || record.date || record.date_of_vaccination || record.insemination_date
                      );
      
                      return (
                          (!selectedSpecies || selectedSpecies === "All" || record[filter.speciesField] === selectedSpecies) &&
                          (!selectedVaccination || selectedVaccination === "All" || record[filter.vaccinationField] === selectedVaccination) &&
                          (!selectedCounty || selectedCounty === "All" || record[filter.countyField] === selectedCounty) &&
                          (!selectedCategory || selectedCategory === "All" || record[filter.categoryField] === selectedCategory) &&
                          (!dateFrom || recordDate >= dateFrom) &&
                          (!dateTo || recordDate <= dateTo)
                      );
                  });
      
                  // ✅ Sum total
                  const total = filter.sumField
                      ? filteredData.reduce((sum, record) => sum + (record[filter.sumField] || 0), 0)
                      : filteredData.length;
      
                  totalElement.textContent = total;
      
                  // ✅ If "All", log sum per assigned_by_username
                  if (selectedUser === "All" && filter.userField && filter.sumField) {
                      const totalByUser = {};
      
                      filteredData.forEach(record => {
                          const user = record[filter.userField];
                          const value = record[filter.sumField] || 0;
                          if (!totalByUser[user]) {
                              totalByUser[user] = 0;
                          }
                          totalByUser[user] += value;
                      });
      
                      
                  }
              }
      
              // ✅ Add event listeners
              const filterElements = [
                  userDropdown,
                  speciesDropdown,
                  countyDropdown,
                  categoryDropdown,
                  dateFromInput,
                  dateToInput,
                  vaccinationDropdown
              ].filter(Boolean);
      
              filterElements.forEach(element => {
                  element.addEventListener("change", filterData);
              });
      
              fetchData();
          });
      });
      
        </script>
        
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const calendar = new VanillaCalendar('#calendar');
          calendar.init();
        });
      </script>
  <script>
    $(document).ready(function() {
      // Javascript method's body can be found in assets/js/demos.js
      demo.initDashboardPageCharts();

    });
  </script>
</body>

{% endblock %}






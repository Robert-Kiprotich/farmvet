{% extends 'portals/base.html' %}

{% load static %}

{% block content %}
{% if role == "farmer" %}
    {% include 'portals/sidebarFarmer.html' %}
{% elif role == "vet" %}
    {% include 'portals/sidebarVet.html' %}
{% endif %}
 
<main class="page-content">
<div class="container-fluid">
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-transparent  bg-primary  navbar-absolute">
   
        <div class="container-fluid">
          <div class="navbar-wrapper">
            
          </div>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-bar navbar-kebab"></span>
            <span class="navbar-toggler-bar navbar-kebab"></span>
            <span class="navbar-toggler-bar navbar-kebab"></span>
          </button>
          <div class="collapse navbar-collapse justify-content-end" id="navigation">
            <form>
              <div class="input-group no-border">
                <input type="text" value="" class="form-control" placeholder="Search...">
                <div class="input-group-append">
                  <div class="input-group-text">
                    <i class="now-ui-icons ui-1_zoom-bold"></i>
                  </div>
                </div>
              </div>
            </form>
            <ul class="navbar-nav">
              <li class="nav-item">
                <a class="nav-link" href="#pablo">
                  <i class="now-ui-icons media-2_sound-wave"></i>
                  <p>
                    <span class="d-lg-none d-md-block">Stats</span>
                  </p>
                </a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="now-ui-icons location_world"></i>
                  <p>
                    <span class="d-lg-none d-md-block">Some Actions</span>
                  </p>
                </a>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                  <a class="dropdown-item" href="#">Account Management</a>
                  <a class="dropdown-item" href="#">Profile picture</a>
                  <a class="dropdown-item" href="#">Change Password</a>
                  <a class="dropdown-item" href="{% url 'logout' %}">Logout</a>
                </div>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#pablo">
                  <i class="now-ui-icons users_single-02"></i>
                  <p>
                    <span class="d-lg-none d-md-block">Account</span>
                  </p>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      <!-- End Navbar -->

    
      <div class="panel-header panel-header-lg">
        <canvas id="bigDashboardChart"></canvas>
      </div>
      <div class="content">
        <div class="row">
          <div class="col-md-12">
            <div class="card">
              <div class="card-header">
               <div class="card-body">
                <h2 class="text-center">Take the Quiz</h2>
                <div class="d-flex justify-content-end">
                  <div id="timer" class="fw-bold text-danger" style="font-size: 20px;"></div>
              </div>
                {% if moderator %}
                <h7><strong>These questions Were moderated by:{{moderator.name}} </strong></h7>
                {% else%}
                {% endif %}
                <form id="quiz-form">
                  <div id="quiz-container"></div>
                  <button type="button" id="submit-btn" class="btn btn-md btn-success">Submit</button>
              </form>
            </div> 
      </div>
      </div>
    </div>     
  </div>
  </div>
    
      <footer class="footer">
        <div class=" container-fluid ">
            <div class="copyright">
              &copy; Copyright <strong><span>SoinVet</span></strong>. All Rights Reserved
              <div class="credits">
              
            </div>
          </div>
        </footer><!-- End Footer -->
  <!--   Core JS Files   -->
  

  <script src="{% static 'portals/assets/js/core/jquery.min.js' %}"></script>
  <script src="{% static 'portals/assets/js/core/popper.min.js' %}"></script>
  <script src="{% static 'portals/assets/js/core/bootstrap.min.js' %}"></script>
  <script src="{% static 'portals/assets/js/plugins/perfect-scrollbar.jquery.min.js' %}"></script>
  <!--  Google Maps Plugin    -->
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_KEY_HERE"></script>
  <!-- Chart JS -->
  <script src="{% static 'portals/assets/js/plugins/chartjs.min.js' %}"></script>
  <!--  Notifications Plugin    -->
  <script src="{% static 'portals/assets/js/plugins/bootstrap-notify.js' %}"></script>
  <!-- Control Center for Now Ui Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="{% static 'portals/assets/js/now-ui-dashboard.min.js' %}" type="text/javascript"></script><!-- Now Ui Dashboard DEMO methods, don't include it in your project! -->
  <script src="{% static 'portals/assets/js/main.js' %}"></script>
  <!-- page-wrapper -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"></script>
      <script>
        let userId = "{{ request.user.id }}"; // Get user ID dynamically
    let selectedAnswers = {};
    const timerKey = "quiz_expiration_time"; // Key for storing expiration timestamp in localStorage
    const countdownDuration = 20 * 60 * 1000; // 20 minutes in milliseconds
    const timerDisplay = document.getElementById("timer"); // Timer display element

    function startCountdown(userId) {
        const timerKey = `quiz_timer_user_${userId}`; // Timer is now tied to user ID
        let storedExpirationTime = localStorage.getItem(timerKey);
        let currentTime = Date.now();
    
        // If no timer or it expired, set new one
        if (!storedExpirationTime || currentTime >= storedExpirationTime) {
            storedExpirationTime = currentTime + countdownDuration;
            localStorage.setItem(timerKey, storedExpirationTime);
        } else {
            storedExpirationTime = parseInt(storedExpirationTime, 10); // Ensure it's a number
        }
    
        updateCountdown(storedExpirationTime, timerKey);
    }
    
    function updateCountdown(expirationTime, timerKey) {
        const countdownInterval = setInterval(() => {
            let currentTime = Date.now();
            let remainingTime = expirationTime - currentTime;
    
            if (remainingTime <= 0) {
                clearInterval(countdownInterval);
                localStorage.removeItem(timerKey); // Clear stored time
                submitQuiz(); // Submit quiz automatically
                return;
            }
    
            let minutes = Math.floor(remainingTime / (1000 * 60));
            let seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
            timerDisplay.innerText = `Time left: ${minutes}:${seconds < 10 ? "0" : ""}${seconds}`;
        }, 1000);
    }

   
    async function fetchQuestions(userId) {
      console.log(userId)
      try {
        const response = await fetch(`/start_quiz/?user_id=${userId}`);
        const data = await response.json();
        console.log(data);
    
        if (!data.questions || !Array.isArray(data.questions)) {
          console.error("Invalid questions format:", data);
          return;
        }
    
        const quizContainer = document.getElementById('quiz-container');
        quizContainer.innerHTML = '';
        data.questions.forEach((q, index) => {
          const questionHtml = `
            <div class="card p-3 mt-2">
              <h5>${index + 1}. ${q.text}</h5>
              <div>
                ${Object.keys(q.options).map(opt => `
                  <label>
                    <input type="radio" name="${q.id}" value="${opt}">
                    ${opt}: ${q.options[opt]}
                  </label><br>
                `).join('')}
              </div>
            </div>
          `;
          quizContainer.innerHTML += questionHtml;
        });
    
        // Add event listeners to radio buttons
        addRadioButtonListeners();
    
        document.getElementById('submit-btn').style.display = 'block';
      } catch (error) {
        console.error("Error fetching questions:", error);
      }
    }

    // Collect selected answers from radio buttons
    function collectSelectedAnswers() {
      const questions = document.querySelectorAll('#quiz-container .card'); // Get all question cards
      selectedAnswers = {}; // Reset selectedAnswers object

      questions.forEach((question) => {
        const questionId = question.querySelector('input[type="radio"]').name; // Get question ID (e.g., "q1")
        const selectedOption = question.querySelector('input[type="radio"]:checked'); // Get selected radio button

        if (selectedOption) {
          selectedAnswers[questionId] = selectedOption.value; // Store the selected answer
        } else {
          selectedAnswers[questionId] = null; // No answer selected
        }
      });

      console.log("Selected Answers:", selectedAnswers); // Debugging: Log selected answers
    }

    // Add event listeners to radio buttons
    function addRadioButtonListeners() {
      const radioButtons = document.querySelectorAll('#quiz-container input[type="radio"]');
      radioButtons.forEach((radio) => {
        radio.addEventListener('change', () => {
          collectSelectedAnswers(); // Update selectedAnswers whenever a radio button is clicked
        });
      });
    }

    // Submit quiz answers to the server
    async function submitQuiz() {
      try {
        // Collect selected answers before submitting
        collectSelectedAnswers();

        const response = await fetch('/submit_quiz/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: userId, answers: selectedAnswers })
        });

        const result = await response.json();
        console.log(result);

        let modalTitle = '';
        let modalBody = '';
        let retakeBtnDisabled = false;
        let retakeBtnText = 'Retake';
        let retakeBtnRedirect = '/quiz/';  // Default redirect to the quiz page
        let showResultsBtn = false;
        let resultsPage = '/score/';  // Page to show the results
        let showRetakeBtn = false;

        // Hide both icons initially
        document.getElementById('success-icon').style.display = 'none';
        document.getElementById('failure-icon').style.display = 'none';

        if (response.ok) {
          // Success - Show score and message
          modalTitle = 'Quiz Submitted';
          modalBody = `
            <h4>Score: ${result.score}</h4>
            <p>${result.message}</p>
            <p>Retakes Left: ${result.retakes_left !== undefined ? result.retakes_left : 0}</p>
          `;

          if (result.score >= 80) {
            // If user passes the test (score >= 80), show success icon
            document.getElementById('success-icon').style.display = 'block'; // Show success icon
            document.getElementById('failure-icon').style.display = 'none';  // Hide failure icon
            document.getElementById('modal-title').classList.remove('text-danger');
            document.getElementById('modal-title').classList.add('text-success');
            document.getElementById('modal-title').textContent = 'Success';

            // Show "View Results" button
            showResultsBtn = true;
            showRetakeBtn = false;  // Hide retake button
          } else {
            // If user fails the test (score < 80), show failure icon
            document.getElementById('failure-icon').style.display = 'block'; // Show failure icon
            document.getElementById('success-icon').style.display = 'none';  // Hide success icon
            document.getElementById('modal-title').classList.remove('text-success');
            document.getElementById('modal-title').classList.add('text-danger');
            document.getElementById('modal-title').textContent = 'Failed';

            // Allow retake if retakes are available
            if (result.retakes_left < 1) {
              // No retakes left
              retakeBtnDisabled = true;
              modalBody += "<p>You cannot retake the quiz anymore.</p>";
              showRetakeBtn = false;  // Hide retake button
            } else {
              // Retakes are available
              showRetakeBtn = true;
            }
          }
        } else {
          // Failure - Error handling
          modalTitle = 'Error';
          modalBody = `
            <h4>Error</h4>
            <p>${result.error || 'No retakes left please contact admin.'}</p>
          `;

          // Show failure icon and set title color to red
          document.getElementById('failure-icon').style.display = 'block'; // Show failure icon
          document.getElementById('success-icon').style.display = 'none';  // Hide success icon
          document.getElementById('modal-title').classList.remove('text-success');
          document.getElementById('modal-title').classList.add('text-danger');
          document.getElementById('modal-title').textContent = 'Error';

          showRetakeBtn = false;
        }

        // Update modal content
        document.getElementById('modal-text').innerHTML = modalBody;
        document.getElementById('retake-btn').disabled = retakeBtnDisabled;
        document.getElementById('retake-btn').innerText = retakeBtnText;

        // Control button visibility
        document.getElementById('retake-btn').style.display = showRetakeBtn ? 'block' : 'none';
        document.getElementById('view-results-btn').style.display = showResultsBtn ? 'block' : 'none';

        // Set the redirect link for retake
        document.getElementById('retake-btn').onclick = function () {
          if (showRetakeBtn && retakeBtnRedirect) {
            window.location.href = retakeBtnRedirect;
          }
        };

        // Set the redirect link for result view
        document.getElementById('view-results-btn').onclick = function () {
          window.location.href = resultsPage;
        };

        // Use Bootstrap modal method to show the modal
        let myModal = new bootstrap.Modal(document.getElementById('result-modal'));
        myModal.show();
      } catch (error) {
        console.error("Error submitting quiz:", error);
        // Show modal with a generic error message
        document.getElementById('modal-text').innerHTML = `
          <h4>Error</h4>
          <p>No Retakes left Please Contact Admin.</p>
        `;
        let myModal = new bootstrap.Modal(document.getElementById('result-modal'));
        myModal.show();
      }
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function () {
      // Ensure the DOM is fully loaded before attaching event listeners
      console.log("Adding submit-btn event listener");
      document.getElementById('submit-btn').addEventListener('click', submitQuiz);

      // Close the modal (Close button)
      document.getElementById('cancel-btn').addEventListener('click', function () {
       window.location.reload()
      });

      // Fetch questions on load
      fetchQuestions(userId);
    });
    window.onload = startCountdown;

      </script>
  <script>
    $(document).ready(function() {
      // Javascript method's body can be found in assets/js/demos.js
      demo.initDashboardPageCharts();

    });
  </script>
</body>

{% endblock %}





